<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Hotel Booking</title>
    <link rel="stylesheet" href="../styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <h2>Happy Hotel - Admin</h2>
            </div>
            <ul class="nav-menu">
                <li><a href="../index.html">Home</a></li>
                <li><a href="admin-dashboard.html" class="active">Dashboard</a></li>
                <li><a href="add-room.html">Add Room</a></li>
                <li><a href="manage-bookings.html">Bookings</a></li>
                <li id="userNav">
                    <span id="userName"></span>
                    <button onclick="logout()" class="btn-logout">Logout</button>
                </li>
                <li>
                    <div class="theme-toggle" onclick="toggleDarkMode()">
                        <div class="theme-toggle-slider">‚òÄÔ∏è</div>
                    </div>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Page Header -->
    <section class="page-header dashboard-banner">
        <div class="banner-overlay"></div>
        <div class="container">
            <h1>Admin Dashboard</h1>
            <p>Manage rooms and view statistics</p>
        </div>
    </section>

    <!-- Dashboard Stats -->
    <section class="dashboard-stats">
        <div class="container">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Rooms</h3>
                    <p class="stat-number" id="totalRooms">0</p>
                    <span class="stat-label">All room types</span>
                </div>
                <div class="stat-card">
                    <h3>Total Bookings</h3>
                    <p class="stat-number" id="totalBookings">0</p>
                    <span class="stat-label">Lifetime bookings</span>
                </div>
                <div class="stat-card">
                    <h3>Active Bookings</h3>
                    <p class="stat-number" id="activeBookings">0</p>
                    <span class="stat-label">Current reservations</span>
                </div>
                <div class="stat-card">
                    <h3>Total Revenue</h3>
                    <p class="stat-number" id="totalRevenue">$0</p>
                    <span class="stat-label">All-time earnings</span>
                </div>
                <div class="stat-card">
                    <h3>Most Booked</h3>
                    <p class="stat-number" id="mostBooked" style="font-size: 1.5rem;">-</p>
                    <span class="stat-label">Room type</span>
                </div>
            </div>
        </div>
    </section>

    <!-- Charts Section -->
    <section class="admin-section">
        <div class="container">
            <h2 style="margin-bottom: 2rem; color: var(--text-primary);">Analytics & Insights</h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem; margin-bottom: 3rem;">
                <div class="card">
                    <h3 style="margin-bottom: 1.5rem; color: var(--text-primary);">Monthly Revenue</h3>
                    <canvas id="revenueChart"></canvas>
                </div>
                
                <div class="card">
                    <h3 style="margin-bottom: 1.5rem; color: var(--text-primary);">Room Type Distribution</h3>
                    <canvas id="roomTypeChart"></canvas>
                </div>
            </div>
        </div>
    </section>

    <!-- Recent Bookings -->
    <section class="admin-section">
        <div class="container">
            <h2 style="margin-bottom: 1.5rem; color: var(--text-primary);">Recent Bookings</h2>
            <div id="recentBookingsTable">
                <div class="loading">Loading recent bookings...</div>
            </div>
        </div>
    </section>

    <!-- Room Management -->
    <section class="admin-section">
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <div>
                    <h2 style="margin: 0; color: var(--text-primary);">Room Management</h2>
                    <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary);">Manage room availability and out-of-order status</p>
                </div>
                <button onclick="openFeaturesModal()" class="btn btn-secondary" style="background: var(--orange-color); color: white;">
                    üè∑Ô∏è Manage Room Features
                </button>
            </div>
            <div id="roomsTable">
                <div class="loading">Loading rooms...</div>
            </div>
        </div>
    </section>

    <!-- Room Features Management Modal -->
    <div id="featuresModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>üè∑Ô∏è Manage Room Features</h2>
                <span class="close" onclick="closeFeaturesModal()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Add New Feature Form -->
                <div class="feature-form-section">
                    <h3>Add New Feature</h3>
                    <form id="addFeatureForm" onsubmit="handleAddFeature(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="featureName">Feature Name *</label>
                                <input type="text" id="featureName" required placeholder="e.g., WiFi, Air Conditioning">
                            </div>
                            <div class="form-group">
                                <label for="featureIcon">Icon</label>
                                <input type="text" id="featureIcon" placeholder="e.g., üì∂, ‚ùÑÔ∏è, üç≥" maxlength="2">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="featureDescription">Description (optional)</label>
                            <input type="text" id="featureDescription" placeholder="Brief description of the feature">
                        </div>
                        <button type="submit" class="btn btn-primary">Add Feature</button>
                    </form>
                </div>

                <!-- Existing Features List -->
                <div class="features-list-section">
                    <h3>Existing Features</h3>
                    <div id="featuresList">
                        <div class="loading">Loading features...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Feature Confirmation Modal -->
    <div id="deleteFeatureModal" class="modal">
        <div class="modal-content modal-small">
            <h3>Delete Feature?</h3>
            <p>Are you sure you want to delete this feature? This will remove it from all rooms that use it.</p>
            <div class="modal-actions">
                <button onclick="confirmDeleteFeature()" class="btn btn-danger">Yes, Delete</button>
                <button onclick="closeDeleteFeatureModal()" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Edit Room Modal -->
    <div id="editRoomModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Room</h2>
                <span class="close" onclick="closeEditRoomModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editRoomForm" onsubmit="handleEditRoom(event)">
                    <input type="hidden" id="editRoomId">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editRoomNumber">Room Number: *</label>
                            <input type="number" id="editRoomNumber" min="1" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="editType">Room Type: *</label>
                            <select id="editType" required>
                                <option value="">Select Type</option>
                                <option value="Single">Single</option>
                                <option value="Double">Double</option>
                                <option value="Suite">Suite</option>
                                <option value="Deluxe">Deluxe</option>
                                <option value="Presidential">Presidential</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editPrice">Price per Night ($): *</label>
                            <input type="number" id="editPrice" min="0" step="0.01" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="editCapacity">Capacity (guests): *</label>
                            <input type="number" id="editCapacity" min="1" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="editDescription">Description: *</label>
                        <textarea id="editDescription" rows="5" placeholder="Enter room description..." required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="editImages">Image URLs (comma-separated):</label>
                        <input type="text" id="editImages" placeholder="https://example.com/image1.jpg, https://example.com/image2.jpg">
                        <small>Enter multiple image URLs separated by commas</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="editAmenities">Amenities (comma-separated):</label>
                        <input type="text" id="editAmenities" placeholder="WiFi, TV, Air Conditioning, Mini Bar">
                        <small>Enter amenities separated by commas</small>
                    </div>
                    
                    <!-- Room Features Selection -->
                    <div class="features-selection">
                        <h4>Room Features</h4>
                        <div id="editFeaturesCheckboxGrid" class="features-checkbox-grid">
                            <!-- Features will be loaded here -->
                        </div>
                    </div>
                    
                    <div class="form-group checkbox-group">
                        <label>
                            <input type="checkbox" id="editAvailable">
                            Room Available for Booking
                        </label>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Update Room</button>
                        <button type="button" onclick="closeEditRoomModal()" class="btn btn-secondary">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content modal-small">
            <h3>Delete Room?</h3>
            <p>Are you sure you want to delete this room? This action cannot be undone.</p>
            <div class="modal-actions">
                <button onclick="confirmDeleteRoom()" class="btn btn-danger">Yes, Delete</button>
                <button onclick="closeDeleteModal()" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 Happy Hotel. All rights reserved.</p>
        </div>
    </footer>

    <script src="../env-config.js"></script>
    <script src="../script.js"></script>
    <script>
        let roomToDelete = null;
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        // Check if user is admin
        if (!token || user.role !== 'admin') {
            alert('Admin access required');
            window.location.href = '../pages/login.html';
        } else {
            checkAuth();
            loadDashboardData();
            loadAdminRooms(); // Load room management table
        }

        async function loadDashboardData() {
            await loadDashboardStats();
            await loadRecentBookings();
        }

        let revenueChart = null;
        let roomTypeChart = null;

        async function loadDashboardStats() {
            try {
                const response = await fetchWithAuth(`${API_URL}/admin/stats`);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch stats');
                }

                const stats = await response.json();

                // Update stat cards
                document.getElementById('totalRooms').textContent = stats.totalRooms || 0;
                document.getElementById('totalBookings').textContent = stats.totalBookings || 0;
                document.getElementById('activeBookings').textContent = stats.activeBookings || 0;
                document.getElementById('totalRevenue').textContent = `$${stats.totalRevenue?.toLocaleString() || 0}`;
                document.getElementById('mostBooked').textContent = stats.mostBookedType || 'N/A';

                // Create Revenue Chart
                createRevenueChart(stats.monthlyRevenue || []);
                
                // Create Room Type Distribution Chart
                createRoomTypeChart(stats.roomTypeDistribution || []);

            } catch (error) {
                console.error('Error loading dashboard stats:', error);
                showToast('Error loading dashboard statistics', 'error');
            }
        }

        function createRevenueChart(monthlyData) {
            const ctx = document.getElementById('revenueChart');
            if (!ctx) return;

            // Destroy existing chart if exists
            if (revenueChart) {
                revenueChart.destroy();
            }

            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const textColor = isDark ? '#f1f5f9' : '#1e293b';
            const gridColor = isDark ? '#475569' : '#e2e8f0';

            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthlyData.map(d => d.month),
                    datasets: [{
                        label: 'Revenue ($)',
                        data: monthlyData.map(d => d.revenue),
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            labels: { color: textColor }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: textColor },
                            grid: { color: gridColor }
                        },
                        x: {
                            ticks: { color: textColor },
                            grid: { color: gridColor }
                        }
                    }
                }
            });
        }

        function createRoomTypeChart(roomTypeData) {
            const ctx = document.getElementById('roomTypeChart');
            if (!ctx) return;

            // Destroy existing chart if exists
            if (roomTypeChart) {
                roomTypeChart.destroy();
            }

            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const textColor = isDark ? '#f1f5f9' : '#1e293b';

            const colors = ['#2563eb', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];

            roomTypeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: roomTypeData.map(d => d._id),
                    datasets: [{
                        data: roomTypeData.map(d => d.count),
                        backgroundColor: colors.slice(0, roomTypeData.length),
                        borderWidth: 2,
                        borderColor: isDark ? '#1e293b' : '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: textColor, padding: 15 }
                        }
                    }
                }
            });
        }

        async function loadRecentBookings() {
            try {
                const response = await fetchWithAuth(`${API_URL}/admin/bookings?limit=10`);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch bookings');
                }

                const bookings = await response.json();
                const recentBookings = bookings.slice(0, 10);

                const container = document.getElementById('recentBookingsTable');

                if (recentBookings.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary);">No recent bookings</p>';
                    return;
                }

                container.innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Booking Code</th>
                                <th>Guest</th>
                                <th>Room</th>
                                <th>Check-in</th>
                                <th>Check-out</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Payment</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${recentBookings.map(booking => `
                                <tr>
                                    <td><strong>${booking.bookingCode || 'N/A'}</strong></td>
                                    <td>${booking.userId?.name || 'Unknown'}</td>
                                    <td>Room ${booking.roomId?.roomNumber || 'N/A'} (${booking.roomId?.type || ''})</td>
                                    <td>${new Date(booking.checkIn).toLocaleDateString()}</td>
                                    <td>${new Date(booking.checkOut).toLocaleDateString()}</td>
                                    <td>$${booking.totalPrice}</td>
                                    <td>
                                        <span class="status-badge status-${booking.status}">
                                            ${booking.status}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="status-badge status-${booking.paymentStatus?.toLowerCase() || 'pending'}">
                                            ${booking.paymentStatus || 'Pending'}
                                        </span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading recent bookings:', error);
            }
        }

        async function loadAdminRooms() {
            try {
                const response = await fetch(`${API_URL}/rooms`);
                const rooms = await response.json();

                const roomsTable = document.getElementById('roomsTable');

                if (rooms.length === 0) {
                    roomsTable.innerHTML = '<p>No rooms available. <a href="add-room.html">Add a room</a></p>';
                    return;
                }

                roomsTable.innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Room #</th>
                                <th>Type</th>
                                <th>Price</th>
                                <th>Capacity</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rooms.map(room => `
                                <tr class="${room.outOfOrder ? 'out-of-order-row' : ''}">
                                    <td>${room.roomNumber}</td>
                                    <td>${room.type}</td>
                                    <td>$${room.price}</td>
                                    <td>${room.capacity}</td>
                                    <td>
                                        ${room.outOfOrder 
                                            ? '<span class="status-badge status-out-of-order">Out of Order</span>'
                                            : room.available 
                                                ? '<span class="status-badge status-available">Available</span>'
                                                : '<span class="status-badge status-unavailable">Unavailable</span>'
                                        }
                                    </td>
                                    <td>
                                        <button onclick="editRoom('${room._id}')" class="btn btn-small btn-primary" style="margin-right: 5px;">Edit</button>
                                        <button onclick="toggleOutOfOrder('${room._id}', ${!room.outOfOrder})" 
                                                class="btn btn-small ${room.outOfOrder ? 'btn-success' : 'btn-warning'}" 
                                                style="margin-right: 5px;">
                                            ${room.outOfOrder ? 'Set Available' : 'Mark Out of Order'}
                                        </button>
                                        <button onclick="showDeleteModal('${room._id}')" class="btn btn-small btn-danger">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading rooms:', error);
                document.getElementById('roomsTable').innerHTML = '<p class="error-message">Error loading rooms</p>';
            }
        }



        async function toggleOutOfOrder(roomId, setOutOfOrder) {
            try {
                const response = await fetch(`${API_URL}/rooms/${roomId}/outOfOrder`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    showAlert(data.message, 'success');
                    loadAdminRooms(); // Reload the rooms table
                    loadDashboardData(); // Reload stats
                } else {
                    const data = await response.json();
                    showAlert(data.message || 'Error updating room status', 'error');
                }
            } catch (error) {
                console.error('Error toggling room out of order status:', error);
                showAlert('Error updating room status', 'error');
            }
        }

        function showDeleteModal(roomId) {
            roomToDelete = roomId;
            document.getElementById('deleteModal').style.display = 'block';
        }

        function closeDeleteModal() {
            roomToDelete = null;
            document.getElementById('deleteModal').style.display = 'none';
        }

        // Room Features Management
        let featureToDelete = null;

        async function openFeaturesModal() {
            document.getElementById('featuresModal').style.display = 'block';
            await loadFeatures();
        }

        function closeFeaturesModal() {
            document.getElementById('featuresModal').style.display = 'none';
            document.getElementById('addFeatureForm').reset();
        }

        async function loadFeatures() {
            try {
                const response = await fetch(`${API_URL}/features/all`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const features = await response.json();
                    displayFeatures(features);
                } else {
                    document.getElementById('featuresList').innerHTML = '<p class="error-message">Error loading features</p>';
                }
            } catch (error) {
                console.error('Error loading features:', error);
                document.getElementById('featuresList').innerHTML = '<p class="error-message">Error loading features</p>';
            }
        }

        function displayFeatures(features) {
            const featuresList = document.getElementById('featuresList');

            if (features.length === 0) {
                featuresList.innerHTML = '<p style="color: var(--text-secondary);">No features added yet. Create your first feature above.</p>';
                return;
            }

            featuresList.innerHTML = `
                <div class="features-grid">
                    ${features.map(feature => `
                        <div class="feature-item ${!feature.isActive ? 'inactive' : ''}">
                            <div class="feature-info">
                                <span class="feature-icon">${feature.icon}</span>
                                <div class="feature-details">
                                    <strong>${feature.name}</strong>
                                    ${feature.description ? `<small>${feature.description}</small>` : ''}
                                </div>
                            </div>
                            <div class="feature-actions">
                                <button onclick="toggleFeatureStatus('${feature._id}', ${!feature.isActive})" 
                                        class="btn btn-small ${feature.isActive ? 'btn-warning' : 'btn-success'}">
                                    ${feature.isActive ? 'Deactivate' : 'Activate'}
                                </button>
                                <button onclick="showDeleteFeatureModal('${feature._id}')" 
                                        class="btn btn-small btn-danger">Delete</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        async function handleAddFeature(event) {
            event.preventDefault();

            const featureData = {
                name: document.getElementById('featureName').value.trim(),
                icon: document.getElementById('featureIcon').value.trim() || 'üè®',
                description: document.getElementById('featureDescription').value.trim()
            };

            try {
                const response = await fetch(`${API_URL}/features`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(featureData)
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('Feature added successfully', 'success');
                    document.getElementById('addFeatureForm').reset();
                    await loadFeatures();
                } else {
                    showAlert(data.message || 'Failed to add feature', 'error');
                }
            } catch (error) {
                console.error('Error adding feature:', error);
                showAlert('Error adding feature', 'error');
            }
        }

        async function toggleFeatureStatus(featureId, isActive) {
            try {
                const response = await fetch(`${API_URL}/features/${featureId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ isActive })
                });

                if (response.ok) {
                    showAlert(`Feature ${isActive ? 'activated' : 'deactivated'} successfully`, 'success');
                    await loadFeatures();
                } else {
                    const data = await response.json();
                    showAlert(data.message || 'Failed to update feature', 'error');
                }
            } catch (error) {
                console.error('Error updating feature:', error);
                showAlert('Error updating feature', 'error');
            }
        }

        function showDeleteFeatureModal(featureId) {
            featureToDelete = featureId;
            document.getElementById('deleteFeatureModal').style.display = 'block';
        }

        function closeDeleteFeatureModal() {
            featureToDelete = null;
            document.getElementById('deleteFeatureModal').style.display = 'none';
        }

        async function confirmDeleteFeature() {
            if (!featureToDelete) return;

            try {
                const response = await fetch(`${API_URL}/features/${featureToDelete}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    showAlert('Feature deleted successfully', 'success');
                    closeDeleteFeatureModal();
                    await loadFeatures();
                } else {
                    const data = await response.json();
                    showAlert(data.message || 'Failed to delete feature', 'error');
                }
            } catch (error) {
                console.error('Error deleting feature:', error);
                showAlert('Error deleting feature', 'error');
            }
        }

        async function confirmDeleteRoom() {
            if (!roomToDelete) return;

            try {
                const response = await fetch(`${API_URL}/rooms/${roomToDelete}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('Room deleted successfully', 'success');
                    closeDeleteModal();
                    loadDashboardData();
                } else {
                    showAlert(data.message || 'Failed to delete room', 'error');
                }
            } catch (error) {
                console.error('Error deleting room:', error);
                showAlert('Error deleting room', 'error');
            }
        }

        // Edit Room Functions
        async function editRoom(roomId) {
            try {
                // Fetch room details
                const response = await fetch(`${API_URL}/rooms/${roomId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const room = await response.json();
                    
                    // Populate form fields
                    document.getElementById('editRoomId').value = room._id;
                    document.getElementById('editRoomNumber').value = room.roomNumber;
                    document.getElementById('editType').value = room.type;
                    document.getElementById('editPrice').value = room.price;
                    document.getElementById('editCapacity').value = room.capacity;
                    document.getElementById('editDescription').value = room.description;
                    document.getElementById('editImages').value = room.images ? room.images.join(', ') : '';
                    document.getElementById('editAmenities').value = room.amenities ? room.amenities.join(', ') : '';
                    document.getElementById('editAvailable').checked = room.available;

                    // Load features and populate checkboxes
                    await loadEditRoomFeatures(room.features || []);
                    
                    // Show modal
                    document.getElementById('editRoomModal').style.display = 'block';
                } else {
                    showAlert('Failed to load room details', 'error');
                }
            } catch (error) {
                console.error('Error loading room:', error);
                showAlert('Error loading room details', 'error');
            }
        }

        async function loadEditRoomFeatures(roomFeatures) {
            try {
                const response = await fetch(`${API_URL}/features`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const allFeatures = await response.json();
                    const activeFeatures = allFeatures.filter(f => f.isActive);
                    renderEditFeaturesCheckboxes(activeFeatures, roomFeatures);
                } else {
                    console.error('Failed to load features for edit');
                }
            } catch (error) {
                console.error('Error loading features for edit:', error);
            }
        }

        function renderEditFeaturesCheckboxes(features, selectedFeatures) {
            const grid = document.getElementById('editFeaturesCheckboxGrid');
            
            if (features.length === 0) {
                grid.innerHTML = '<p style="color: var(--text-secondary); font-style: italic;">No features available.</p>';
                return;
            }

            const selectedIds = selectedFeatures.map(f => f._id || f);

            grid.innerHTML = features.map(feature => {
                const isSelected = selectedIds.includes(feature._id);
                return `
                    <div class="feature-checkbox ${isSelected ? 'selected' : ''}" onclick="toggleEditFeature(this, '${feature._id}')">
                        <input type="checkbox" name="editFeatures" value="${feature._id}" ${isSelected ? 'checked' : ''} onchange="event.stopPropagation();">
                        <span class="feature-checkbox-icon">${feature.icon}</span>
                        <span class="feature-checkbox-label">${feature.name}</span>
                    </div>
                `;
            }).join('');
        }

        function toggleEditFeature(element, featureId) {
            const checkbox = element.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            element.classList.toggle('selected', checkbox.checked);
        }

        async function handleEditRoom(event) {
            event.preventDefault();

            const imagesInput = document.getElementById('editImages').value;
            const amenitiesInput = document.getElementById('editAmenities').value;
            
            // Get selected features
            const selectedFeatures = Array.from(document.querySelectorAll('input[name="editFeatures"]:checked'))
                .map(checkbox => checkbox.value);

            const roomData = {
                roomNumber: parseInt(document.getElementById('editRoomNumber').value),
                type: document.getElementById('editType').value,
                price: parseFloat(document.getElementById('editPrice').value),
                capacity: parseInt(document.getElementById('editCapacity').value),
                description: document.getElementById('editDescription').value,
                images: imagesInput ? imagesInput.split(',').map(url => url.trim()) : [],
                amenities: amenitiesInput ? amenitiesInput.split(',').map(a => a.trim()) : [],
                features: selectedFeatures,
                available: document.getElementById('editAvailable').checked
            };

            const roomId = document.getElementById('editRoomId').value;

            try {
                const response = await fetch(`${API_URL}/rooms/${roomId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(roomData)
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('Room updated successfully!', 'success');
                    closeEditRoomModal();
                    loadDashboardData();
                } else {
                    showAlert(data.message || 'Failed to update room', 'error');
                }
            } catch (error) {
                console.error('Error updating room:', error);
                showAlert('Error updating room. Please try again.', 'error');
            }
        }

        function closeEditRoomModal() {
            document.getElementById('editRoomModal').style.display = 'none';
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const editModal = document.getElementById('editRoomModal');
            if (event.target === editModal) {
                closeEditRoomModal();
            }
        }
    </script>
</body>
</html>
